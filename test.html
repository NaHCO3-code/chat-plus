<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        .sendT{
            color:dodgerblue;
            font-weight: bold;
        }
        .getT{
            color:forestgreen;
            font-weight: bold;
        }
        #receive{
            height: 450px;
            overflow: scroll;
        }
    </style>
</head>
<body>
<div><p>eventname</p><input type="text" id="eventname" /></div>
<div><p>message  </p><textarea cols="150" rows="15" id="msg"></textarea></div>
<br/>
<input type="button" id="event" value="发送自定义事件">
<hr/>
<ul id="receive"></ul>
 

<script src="http://localhost:3000/socket.io/socket.io.js"></script>
<script>
        /**
     * 对字符串加密
     * 给定两个字符串进行加密
     * @param text{String} 要加密的值
     * @param key{String} 加密key
     */
     function xor(text, key){
        let textlen = text.length;
        let keylen = key.length;
        let res = '';
        for(let i=0; i<textlen; i++){
            res += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i%keylen));
        }
        return res;
    }
</script>
<script>
    var socket = io.connect('http://localhost:3000');
    let pwd = 1145;
    var gets = {
        "message": (data)=>{},
        "check": (data)=>{},
        "safesend": (data) => {
            socket.emit('message', xor(data, pwd))
        },
    }
 
    //连接成功时触发
    socket.on('connect', function () {
        console.log('连接成功');
    });
 
    //连接断开时触发
    socket.on('disconnect', function () {
        console.log('连接断开');
    });
    
    Object.keys(gets).forEach((val)=>{
        //收到消息时触发
        socket.on(val, function (data) {
            var node = document.createElement("li");
            var ul = document.querySelector('#receive');
            var aft = document.querySelector('.lasest');
            node.innerHTML = `<p class="getT">⬇收到: </p> (${val}) ${data}`
            document.querySelector("#receive").appendChild(node);
            ul.scrollTop = ul.scrollHeight
            gets[val](data);
        });        
    })

 
 
    document.querySelector("#event").onclick = function () {
        var msg = document.querySelector("#msg").value;
        var ul = document.querySelector('#receive');
        var etn = document.querySelector('#eventname').value;
        //参数一表示，事件的名称
        //参数二表示，要发送的数据
        socket.emit(etn, msg);
        var node = document.createElement("li");
        node.innerHTML = `<p class="sendT">⬆发送</p> (${etn}) ${msg}`
        document.querySelector("#receive").appendChild(node);
        ul.scrollTop = ul.scrollHeight
    };




    function safesend(value){
        pwd = String.fromCharCode(Math.floor(Math.random()*10000))
        socket.emit('safesend', xor(value,pwd))
    }
</script>
</body>
</html>